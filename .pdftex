#!/bin/bash
# This file compiles and opens a user specified LaTeX file in xreader.
# Example command: /path/of/texfile pdftex filename &

#If a latex 'build' directory does not exist, create it.
if ! (ls | grep build* >/dev/null)
then
	mkdir build 
fi

file="${1%%.tex*}"

# Run pdflatex on the file. Twice, to ensure it compiles all the references.
pdflatex $file >/dev/null
pdflatex $file >/dev/null
# "Hide" the .tex file and python files of the same name, move all pdflatex 'build files' to /build, "unhide" the .tex file
mv ${file}Notes.bib build/ &>/dev/null
mv $file.tex .$file.tex 
mv $file.py .$file.py &>/dev/null
mv $file.* build
mv .$file.tex $file.tex
mv .$file.py $file.py &>/dev/null

function openCheck {
	ps ax | grep -v grep | grep -w "$PDFVIEWER" > /dev/null
}

x=1
while [ $x -le 2 ]
do
	if openCheck;
	then
#		echo "PDF of document open already, refreshing."
		# Run pdflatex on the file. Twice, to ensure it compiles all the references.
		pdflatex $file >/dev/null
		pdflatex $file >/dev/null
		# "Hide" the .tex file, move all pdflatex 'build files' to /build, "unhide" the .tex file
		mv ${file}Notes.bib build/ &>/dev/null
		mv $file.tex .$file.tex 
		mv $file.py .$file.py &>/dev/null
		mv $file.* build
		mv .$file.tex $file.tex
		mv .$file.py $file.py &>/dev/null

	# Open the compiled pdf
	else
		if [ $x -gt 1 ];
		then
			echo "Exiting."	
			exit 0 
		else
			echo "No PDF of document open yet, opening."
			$PDFVIEWER build/$file.pdf & disown 
			(( x++ )) # Stops the program so it doesn't run forever
		fi
	fi
	sleep 5s
done
